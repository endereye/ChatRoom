# ChatRoom

计算机网络综合项目

## 协议设计

### 通用字段

| 字段类型   | 字段长度（字节） | 字段含义                                               |
| ---------- | ---------------- | ------------------------------------------------------ |
| 控制字节   | 1                | 描述本次通讯的作用，必须是通讯的第一个字节             |
| 用户标识   | 4                | 标识一个用户                                           |
| 用户信息   | 21               | 描述一个用户，由4B用户标识、1B关系标志、16B用户名组成  |
| 群聊标识   | 4                | 标识一个群聊                                           |
| 群聊信息   | 21               | 描述一个群聊，由4B群聊标识、1B关系标志、16B群聊名组成  |
| 数组       |                  | 先发送4B数组长度（无符号整数），再依次跟随数组的每一项 |
| 定长字符串 | 16               | 固定长度（字节）的字符串，不足长度的在末尾补0          |
| 消息字符串 |                  | 描述一条消息，由4B消息长度（字节）、不定长消息内容组成 |

关系标志用于描述一个群聊和一个用户之间的关系，具体是哪个群聊或者用户取决于上下文。

| 比特位 | 含义                                                   | 有效条件                         |
| ------ | ------------------------------------------------------ | -------------------------------- |
| 0x01   | 该用户是否是该群聊的成员之一                           |                                  |
| 0x02   | 该用户是否是该群聊的创建者                             |                                  |
| 0x04   | 该用户加入该群聊的原因（0：受创建者邀请；1：主动加入） | 仅当0x10位为1时有效              |
| 0x08   | 该用户离开该群聊的原因（0：被创建者移除；1：主动离开） | 仅当0x20位为1时有效              |
| 0x10   | 该用户是否刚刚加入该群聊                               | 仅当服务器广播群聊成员变更时有效 |
| 0x20   | 该用户是否刚刚离开该群聊                               | 仅当服务器广播群聊成员变更时有效 |
| 0x40   | 不使用                                                 |                                  |
| 0x80   | 不使用                                                 |                                  |

### 客户端至服务端

#### C1 获得用户列表

| 字段类型 | 字段含义 |
| -------- | -------- |
| 控制字节 |          |

#### C2 获得群聊列表

| 字段类型         | 字段含义          |
| ---------------- | ----------------- |
| 控制字节         |                   |

#### C3 获得群聊成员列表

| 字段类型 | 字段含义             |
| -------- | -------------------- |
| 控制字节 |                      |
| 群聊标识 | 欲获得成员信息的群聊 |

#### C4 请求登录

| 字段类型   | 字段含义                          |
| ---------- | --------------------------------- |
| 控制字节   |                                   |
| 定长字符串 | 欲登录的用户的用户名              |
| 定长字符串 | 欲登录的用户的密码（16位小写MD5） |

#### C5 请求创建群聊

| 字段类型   | 字段含义             |
| ---------- | -------------------- |
| 控制字节   |                      |
| 定长字符串 | 欲创建的群聊的群聊名 |

#### C6 请求加入群聊

| 字段类型 | 字段含义     |
| -------- | ------------ |
| 控制字节 |              |
| 用户标识 | 欲加入的用户 |
| 群聊标识 | 欲加入的群聊 |

若用户等于发送者，表示发送者申请加入群聊；否则，表示发送者邀请他人加入群聊，亦可作为对他人入群申请（S5）的回应，此时发送者必须是群聊的创建者。

#### C7 请求离开群聊

| 字段类型 | 字段含义     |
| -------- | ------------ |
| 控制字节 |              |
| 用户标识 | 欲离开的用户 |
| 群聊标识 | 欲离开的群聊 |

若用户等于发送者，表示发送者主动离开群聊；否则，表示发送者将用户从群聊中移除，此时发送者必须是群聊的创建者。

#### C8 请求发送消息

| 字段类型   | 字段含义     |
| ---------- | ------------ |
| 控制字节   |              |
| 群聊标识   | 欲发送的群聊 |
| 消息字符串 | 欲发送的消息 |

发送者必须是群聊的成员之一。

### 服务端至客户端

#### S1 回复用户列表

| 字段类型         | 字段含义                     |
| ---------------- | ---------------------------- |
| 控制字节         |                              |
| 用户信息（数组） | 用户列表，其中关系标志无意义 |

#### S2 回复群聊列表

| 字段类型         | 字段含义                                       |
| ---------------- | ---------------------------------------------- |
| 控制字节         |                                                |
| 群聊信息（数组） | 群聊列表，其中关系标志表示该群聊和请求者的关系 |

#### S3 回复请求群聊成员列表

| 字段类型         | 字段含义                                           |
| ---------------- | -------------------------------------------------- |
| 控制字节         |                                                    |
| 用户信息（数组） | 成员列表，其中关系标志表示该用户和请求的群聊的关系 |

#### S4 通知登录成功

| 字段类型 | 字段含义         |
| -------- | ---------------- |
| 控制字节 |                  |
| 用户标识 | 请求者的用户标识 |

#### S5 通知他人申请加入群聊

| 字段类型 | 字段含义     |
| -------- | ------------ |
| 控制字节 |              |
| 用户标识 | 欲加入的用户 |
| 群聊标识 | 欲加入的群聊 |

#### S6 广播群聊成员变更

| 字段类型 | 字段含义                                                 |
| -------- | -------------------------------------------------------- |
| 控制字节 |                                                          |
| 用户信息 | 变更的用户，其中关系标志表示变更的用户和变更的群聊的关系 |
| 群聊信息 | 变更的群聊，其中关系标志表示变更的用户和变更的群聊的关系 |

#### S7 广播收到消息

| 字段类型   | 字段含义         |
| ---------- | ---------------- |
| 控制字节   |                  |
| 用户标识   | 发送消息的用户   |
| 群聊标识   | 发送消息的群聊   |
| 消息字符串 | 发送的消息字符串 |
