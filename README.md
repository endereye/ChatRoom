# ChatRoom

重庆大学2018级计算机网络综合项目：简单聊天室。

**本项目实现非常不完善，仅供参考。**

## 协议设计

数组和字符串的发送方式：首先发送4字节数组长度，随后依次发送数组中的每一项。字符串对UTF-8编码后，以字节数组的方式发送。

在下文中，数组的长度被描述为*A(X)*，其中*X*是数组中每一项的长度。特别的，字符串的长度被描述为*A(S)*。

### 客户端至服务端

#### C1 请求登录

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x01 |
| A(S)         | 用户名               |
| A(S)         | 密码的MD5哈希值      |

#### C2 请求会话成员列表


| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x02 |
| 4            | 会话的唯一标识       |

#### C3 请求创建会话

| 长度（字节） | 含义                                 |
| ------------ | ------------------------------------ |
| 1            | 消息类型，恒定为0x03                 |
| A(S)         | 会话名称                             |
| A(4)         | 会话初始成员的唯一标识，不包括创建者 |

#### C4 请求加入会话

| 长度（字节） | 含义                     |
| ------------ | ------------------------ |
| 1            | 消息类型，恒定为0x04     |
| 4            | 希望加入的会话的唯一标识 |
| 4            | 希望加入的用户的唯一标识 |

会话的创建者可以邀请任何人立即加入会话，而其他人发送的申请必须经过创建者的同意才能成功。

#### C5 请求退出会话

| 长度（字节） | 含义                     |
| ------------ | ------------------------ |
| 1            | 消息类型，恒定为0x05     |
| 4            | 希望退出的会话的唯一标识 |
| 4            | 希望退出的用户的唯一标识 |

任何人都可以立即退出自己所在的会话，如果创建者退出了会话，那么该会话会被解散，剩余所有人会被强制退出。

#### C6 发送消息

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x06 |
| 4            | 目标的唯一标识       |
| A(S)         | 字符串形式的消息     |

#### C7 发送文件

| 长度（字节） | 含义                     |
| ------------ | ------------------------ |
| 1            | 消息类型，恒定为0x07     |
| 4            | 目标的唯一标识           |
| A(1)         | 以字节数组形式的文件数据 |

### 服务端至客户端

#### S1 通知登录成功

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x01 |
| 4            | 用户唯一标识         |

#### S2 通知登录失败

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x02 |
| 1            | 失败原因             |

可能的失败原因：

| 代码 | 含义                   |
| ---- | ---------------------- |
| 0x01 | 用户不存在             |
| 0x02 | 密码错误               |
| 0x03 | 该终端已经登录         |
| 0x04 | 该用户已经在另一处登录 |

#### S3 更新用户列表

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x03 |
| A(?)         | 用户列表             |

用户列表中的每一项：

| 长度（字节） | 含义           |
| ------------ | -------------- |
| 4            | 用户的唯一标识 |
| A(S)         | 用户名         |

#### S4 更新会话列表

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x04 |
| A(?)         | 会话列表             |

会话列表中的每一项：

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 4            | 会话的唯一标识       |
| A(S)         | 会话名称             |
| 4            | 会话创建者的唯一标识 |

#### S5 更新会话成员列表

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x05 |
| A(?)         | 成员列表             |

成员列表中的每一项参见S3中的描述。

#### S6 通知加入会话

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x06 |
| 4            | 加入的群聊的唯一标识 |
| 4            | 加入的用户的唯一标识 |
| 1            | 加入的原因           |

可能的加入原因：

| 代码 | 含义                           |
| ---- | ------------------------------ |
| 0x01 | 受创建者邀请（或同意）加入     |
| 0x02 | 创建群聊时，作为创建者自动加入 |

#### S7 通知退出会话

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x07 |
| 4            | 退出的群聊的唯一标识 |
| 4            | 退出的用户的唯一标识 |
| 1            | 退出的原因           |

可能的退出原因：

| 代码 | 含义                         |
| ---- | ---------------------------- |
| 0x01 | 用户下线，自动退出           |
| 0x02 | 创建者将用户移出会话         |
| 0x03 | 用户主动退出                 |
| 0x04 | 创建者解散会话，因此自动退出 |

#### S8 通知其他用户申请加入会话

| 长度（字节） | 含义                 |
| ------------ | -------------------- |
| 1            | 消息类型，恒定为0x08 |
| 4            | 加入的群聊的唯一标识 |
| 4            | 加入的用户的唯一标识 |

#### S9 通知收到消息

| 长度（字节） | 含义                                     |
| ------------ | ---------------------------------------- |
| 1            | 消息类型，恒定为0x09                     |
| 4            | 会话的唯一标识（一对一通讯与发送者相同） |
| 4            | 发送者的唯一标识                         |
| A(S)         | 字符串形式的消息                         |

#### SA 通知收到文件

| 长度（字节） | 含义                                     |
| ------------ | ---------------------------------------- |
| 1            | 消息类型，恒定为0x0A                     |
| 4            | 会话的唯一标识（一对一通讯与发送者相同） |
| 4            | 发送者的唯一标识                         |
| A(1)         | 字节数组形式的文件数据                   |